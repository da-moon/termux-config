#!/data/data/com.termux/files/usr/bin/env bash
# ~/.local/bin/cpy-chunked  — split input into OSC52-safe chunks and copy each chunk

set -euo pipefail

# Conservative payload limit: 74,994 base64 chars (~100k total OSC seq)
# (tmux/screen/terminals often cap at ~100000 bytes for the whole sequence)
PAYLOAD_MAX=4096

# Read stdin and base64-encode without line wraps
b64="$(base64 -w0)"

# Helper to emit one OSC52 sequence (handles tmux/screen pass-through)
emit_osc52() {
  local payload="$1"
  if [ -n "${TMUX-}" ]; then
    # tmux DCS pass-through
    printf '\033Ptmux;\033\033]52;c;%s\007\033\\' "$payload"
  elif [ -n "${STY-}" ]; then
    # screen DCS pass-through
    printf '\033P\033]52;c;%s\007\033\\' "$payload"
  else
    # direct to terminal
    printf '\033]52;c;%s\007' "$payload"
  fi
}

# Send chunks; each becomes a separate clipboard entry in Android’s clipboard history
i=0
len=${#b64}
while [ $i -lt $len ]; do
  emit_osc52 "${b64:$i:$PAYLOAD_MAX}"
  i=$((i + PAYLOAD_MAX))
done
